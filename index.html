async function safeFetchJSON(url) {
  try {
    const res = await fetch(url);
    if (!res.ok) {
      console.error(`Fetch failed: ${url} - Status: ${res.status}`);
      return null;
    }
    return await res.json();
  } catch (err) {
    console.error(`Fetch error: ${url} -`, err);
    return null;
  }
}

async function getUserIdFromUsername(username) {
  const url = `https://api.roblox.plus/v1/users/get-by-username?username=${encodeURIComponent(username)}`;
  const data = await safeFetchJSON(url);
  return data && data.id ? data.id : null;
}

async function getUserInfo(userId) {
  const url = `https://users.roblox.com/v1/users/${userId}`;
  return await safeFetchJSON(url);
}

async function getAvatar(userId) {
  const url = `https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${userId}&size=150x150&format=Png&isCircular=true`;
  const data = await safeFetchJSON(url);
  return data && data.data && data.data[0] ? data.data[0].imageUrl : null;
}

async function getFriendsCount(userId) {
  const url = `https://friends.roblox.com/v1/users/${userId}/friends/count`;
  const data = await safeFetchJSON(url);
  return data ? data.count : null;
}

async function getFollowersCount(userId) {
  const url = `https://friends.roblox.com/v1/users/${userId}/followers/count`;
  const data = await safeFetchJSON(url);
  return data ? data.count : null;
}

async function getFollowingCount(userId) {
  const url = `https://friends.roblox.com/v1/users/${userId}/followings/count`;
  const data = await safeFetchJSON(url);
  return data ? data.count : null;
}

async function getFavoriteGames(userId) {
  const url = `https://favorites.roblox.com/v1/users/${userId}/games/favorites?limit=10`;
  const data = await safeFetchJSON(url);
  return data && data.data ? data.data : [];
}

async function getCreatedGames(userId) {
  const url = `https://games.roblox.com/v2/users/${userId}/games?limit=10`;
  const data = await safeFetchJSON(url);
  return data && data.data ? data.data : [];
}

async function getPlaceVisits(placeId) {
  const url = `https://games.roblox.com/v1/games/multiget-place-details?placeIds=${placeId}`;
  const data = await safeFetchJSON(url);
  if (data && data.data && data.data[0]) {
    return data.data[0].visits || 0;
  }
  return 0;
}

async function searchProfile() {
  resultDiv.innerHTML = '<p class="loading">Loading...</p>';
  const input = userInput.value.trim();
  if (!input) {
    resultDiv.innerHTML = '<p class="error">Please enter a username or user ID.</p>';
    return;
  }

  let userId;
  if (/^\d+$/.test(input)) {
    userId = input;
  } else {
    userId = await getUserIdFromUsername(input);
    if (!userId) {
      resultDiv.innerHTML = `<p class="error">User not found.</p>`;
      return;
    }
  }

  // Fetch all data in parallel, handle nulls gracefully
  const [
    userInfo,
    avatarUrl,
    friendsCount,
    followersCount,
    followingCount,
    favorites,
    createdGames,
  ] = await Promise.all([
    getUserInfo(userId),
    getAvatar(userId),
    getFriendsCount(userId),
    getFollowersCount(userId),
    getFollowingCount(userId),
    getFavoriteGames(userId),
    getCreatedGames(userId),
  ]);

  if (!userInfo) {
    resultDiv.innerHTML = '<p class="error">Failed to load user info.</p>';
    return;
  }

  // Fetch visits for created games (limit to 5 to avoid long waits)
  const limitedGames = createdGames.slice(0, 5);
  const gamesWithVisits = await Promise.all(
    limitedGames.map(async (game) => {
      const visits = await getPlaceVisits(game.rootPlaceId);
      return { ...game, visits };
    })
  );

  // Build output HTML
  resultDiv.innerHTML = `
    <div class="profile">
      <img src="${avatarUrl || 'https://tr.rbxcdn.com/8c4a6705be3f0053c960f71b0d6f5cc9/420/420/AvatarHeadshot/Png'}" alt="Avatar" class="avatar" />
      <div class="info">
        <h2>${userInfo.name}</h2>
        <p><strong>Description:</strong> ${userInfo.description || 'No description'}</p>
        <p><strong>Created:</strong> ${new Date(userInfo.created).toLocaleDateString()}</p>
        <p><strong>Friends:</strong> ${friendsCount ?? 'N/A'}</p>
        <p><strong>Followers:</strong> ${followersCount ?? 'N/A'}</p>
        <p><strong>Following:</strong> ${followingCount ?? 'N/A'}</p>

        <h3>Favorite Games</h3>
        <ul>
          ${
            favorites.length > 0
              ? favorites
                  .map(
                    (game) =>
                      `<li><a href="https://www.roblox.com/games/${game.rootPlaceId}" target="_blank" rel="noopener noreferrer">${game.name}</a></li>`
                  )
                  .join('')
              : '<li>No favorites found</li>'
          }
        </ul>

        <h3>Created Games</h3>
        <ul>
          ${
            gamesWithVisits.length > 0
              ? gamesWithVisits
                  .map(
                    (game) =>
                      `<li><a href="https://www.roblox.com/games/${game.rootPlaceId}" target="_blank" rel="noopener noreferrer">${game.name}</a> - Visits: ${game.visits.toLocaleString()}</li>`
                  )
                  .join('')
              : '<li>No created games found</li>'
          }
        </ul>
      </div>
    </div>
  `;
}

searchBtn.addEventListener('click', searchProfile);
userInput.addEventListener('keyup', (e) => {
  if (e.key === 'Enter') searchProfile();
});
